FROM python:3.7


EXPOSE $KEYSTONE_PORT
RUN apt-get -y update \
    && apt-get install -y --no-install-recommends \
    apache2 \
    libapache2-mod-shib2 \
    libldap2-dev libsasl2-dev \
    libapache2-mod-wsgi-py3 git vim memcached \
    libffi-dev python3-dev libssl-dev mariadb-client libssl-dev \
    && apt-get -y clean

ARG keystone_version
RUN git clone -b "$keystone_version" https://github.com/openstack/keystone.git
RUN git clone -b "$keystone_version" https://github.com/openstack/requirements

RUN useradd --user-group keystone \
    && pip3 install -e /keystone -c /requirements/upper-constraints.txt

RUN pip3 install pbr PyMySQL python-memcached python-openstackclient python-ldap ldappool -c /requirements/upper-constraints.txt \
    && mkdir -p /etc/keystone/credential-keys /var/www/cgi-bin/keystone /var/log/apache2 /home/keystone \
    && cp -r /keystone/etc/* /etc/keystone/

RUN apt-get install -y ldap-utils && pip3 install pydevd lxml
RUN shib-keygen -y 10

ADD ./bootstrap /home/keystone/bootstrap
COPY ./etc/keystone/keystone.ini /etc/keystone/keystone.conf
COPY ./etc/mod_shibboleth/shibboleth2.xml /etc/shibboleth/shibboleth2.xml
COPY ./etc/apache2/keystone.conf /etc/apache2/sites-available/
COPY ./etc/mod_shibboleth/attribute-map.xml /etc/shibboleth/attribute-map.xml
COPY wait-for-it.sh /wait-for-it.sh
ADD ./token.py /token.py
#COPY token.py /token.py

RUN chown -R keystone: /etc/keystone /var/www/cgi-bin/keystone /var/log/apache2 /home/keystone \
    && chown -R _shibd:_shibd  /etc/shibboleth/* \
    && chown -R _shibd:_shibd  /etc/shibboleth/

RUN echo "ServerName $HOSTNAME" >> /etc/apache2/apache2.conf
